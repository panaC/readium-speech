<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Readium Speech Demo</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- <script>
      console.log(speechSynthesis.getVoices());
      setTimeout(() => console.log(speechSynthesis.getVoices()), 1);
  </script> -->
    <script type="module" defer>

      // console.log(speechSynthesis.getVoices());
      // setTimeout(() => console.log(speechSynthesis.getVoices()), 1);

      import { voicesSelection } from "../build/mjs/src/index.js";
      const { getSpeechSynthesisVoices, parseSpeechSynthesisVoices, filterOnNovelty, filterOnVeryLowQuality,
        filterOnRecommended, sortByLanguage, sortByQuality, getVoices, groupByKindOfVoices, groupByRegions,
        getLanguages, filterOnOfflineAvailability, listLanguages, filterOnGender } = voicesSelection;

      // console.log(filterOnRecommended(filterOnVeryLowQuality(filterOnNovelty(parseSpeechSynthesisVoices(await getSpeechSynthesisVoices())))));
      // console.log(sortByLanguage(sortByQuality(filterOnRecommended(filterOnVeryLowQuality(filterOnNovelty(parseSpeechSynthesisVoices(await getSpeechSynthesisVoices()))))[0])));

      async function postToServer(url, data) {
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `text=${encodeURIComponent(data)}`,
          });

          if (!response.ok) {
            throw new Error(`HTTP error status: ${response.status}`);
          }

          const result = await response.json();
          console.log(result);
          pushResponseDiv.innerText = JSON.stringify(result, null, 4);
        } catch (error) {
          console.error('Error posting data:', error);
        }
      }

      let languages = await getLanguages();
      console.log(languages);

      const voices = await getVoices();
      console.log(voices);
      
      // global to access voices in pushToServer
      let voicesFiltered = voices;
      let voicesGroupedByRegions = undefined;

      const allVoices = parseSpeechSynthesisVoices(await getSpeechSynthesisVoices());
      console.log(groupByKindOfVoices(allVoices));
      // console.log(JSON.stringify(Array.from(groupByKindOfVoices(allVoices).entries()), null, 4));

      const languageSelect = document.getElementById('language-select'); 
      const readButton = document.getElementById('read-button');
      const voiceSelect = document.getElementById('voice-select');
      const offlineCheckbox = document.getElementById('offline-checkbox');
      const defaultOption = document.createElement("option");
      const fieldset = document.getElementById('gender-fieldset');
      const genderCheckbox = document.getElementById('gender-checkbox');
      const pushlogButton = document.getElementById('push-voices-button');
      const pushResponseDiv = document.getElementById('push-response-div');

      function setDefaultLanguage() {
        
        defaultOption.defaultSelected = true;
        defaultOption.text = "Select a language";
        languageSelect.appendChild(defaultOption);
      }

      const setFieldStateHiddenOrNot = () => fieldset.style = !genderCheckbox.checked ? "display: none" : "";

      function init() {
        setDefaultLanguage();
        mount();

        setFieldStateHiddenOrNot()

        offlineCheckbox.onchange = (ev) => {
          unmout();
          mount(); 
        }

        genderCheckbox.onchange = () => {
          setFieldStateHiddenOrNot()
          unmout();
          mount(); 
        }

        fieldset.onchange = () => {
          unmout();
          mount();
        }

        pushlogButton.onclick = () => {
          const a = JSON.stringify(Array.from(voicesGroupedByRegions?.entries() || []), null, 4);
          console.log(a);

          postToServer("https://file.io/",
            `${JSON.stringify(voicesFiltered, null, 4)}
          =========
          ${a}`);
        }
      }

      function mount() {

        if (genderCheckbox.checked) {
          const elements = fieldset.elements;
          for (let i = 0; i < elements.length; i++) {
              const element = elements[i];
              if (element.type === 'radio' && element.checked) {
                voicesFiltered = filterOnGender(voicesFiltered, element.value);
              }
          }

        }

        voicesFiltered = offlineCheckbox.checked ? filterOnOfflineAvailability(voicesFiltered, offlineCheckbox.checked) : voicesFiltered;
        languages = listLanguages(voicesFiltered);

        for (const { language: lang, label: langLabel, count: langCount } of languages) {
          const opt = document.createElement("option");
          opt.value = lang;
          opt.text = `${langLabel} (${langCount})`;
          languageSelect.appendChild(opt);
        }
      

        languageSelect.onchange = async () => {

          if (languageSelect.contains(defaultOption))
            languageSelect.removeChild(defaultOption);


          const selectedLanguage = languageSelect.value;

          const jsonData = await loadJSONData("https://raw.githubusercontent.com/HadrienGardeur/web-speech-recommended-voices/main/json/" + selectedLanguage + ".json");

          const defaultText = document.getElementById('text-to-read');
          defaultText.value = jsonData?.testUtterance || "";

          voicesGroupedByRegions = groupByRegions(voicesFiltered, selectedLanguage, undefined, navigator.language.split("-")[0].toLowerCase());
          console.log(voicesGroupedByRegions);

          voiceSelect.innerHTML = "";
          const voiceDropdownHTML = generateVoiceDropdownHTML(voicesGroupedByRegions);
          voiceSelect.innerHTML = voiceDropdownHTML;
        };

        readButton.onclick = readTextWithSelectedVoice;
      }

      function unmout() {
        languageSelect.innerHTML = "";
        languageSelect.defaultSelected;

        setDefaultLanguage();
        
        readButton.onclick = () => {};

        voiceSelect.innerHTML = "";

        voicesFiltered = voices;
      }

      async function loadJSONData(url) {
        try {
          const response = await fetch(url);
          const jsonData = JSON.parse(await response.text());
          return jsonData;
        } catch (error) {
          console.error('Error loading JSON data:', error);
          return null;
        }
      }

      function generateVoiceDropdownHTML(voiceMap) {
        if (!voiceMap) return '';

        const voiceSelect = document.createElement('select');
        voiceSelect.id = 'voice-select';

        for (const [region, voice] of voiceMap) {
          const optgroup = document.createElement('optgroup');
          optgroup.label = region;
          (voice || []).forEach(function (v) {
            const voiceOption = document.createElement('option');
            voiceOption.value = v.name;
            voiceOption.textContent = v.label;
            optgroup.appendChild(voiceOption);
          });
          voiceSelect.appendChild(optgroup);
        }

        return voiceSelect.outerHTML;
      }

      function readTextWithSelectedVoice() {
        const textToRead = document.getElementById('text-to-read').value;
        const selectedVoice = document.getElementById('voice-select').value;
        const voices = window.speechSynthesis.getVoices();

        if (!textToRead || !selectedVoice) return;

        const utterance = new SpeechSynthesisUtterance();
        utterance.text = textToRead;

        for (const voice of voices) {
          if (voice.name === selectedVoice) {
            utterance.voice = voice;
            utterance.lang = voice.lang;
            break;
          }
        }

        speechSynthesis.speak(utterance);
      }

      init();

    </script>
  </head>
  
  <body>
    <h1>Readium Speech Demo</h1>
  
    <p>Language :</p>
    <select id="language-select">
      <!-- <option id="default-language-select" default>Select a language</option> -->
    </select>
  
    <p>Voices :</p>
    <select id="voice-select"></select>
  
    <p>Text :</p>
    <input id="text-to-read" class="txt"></input>
  
    <div class="controls">
      <button id="read-button">Read aloud</button>

      <div>
        <input id="offline-checkbox" type="checkbox"></input>
        <label for="offline-checkbox">Filter on voice available offline</label>
      </div>
    
      <div>
        <input id="gender-checkbox" type="checkbox" ></input>
        <label for="gender-checkbox">Filter on gender</label>
      </div>
      <fieldset id="gender-fieldset" style="display: none;">
        <legend>Select a gender:</legend>

        <div>
          <input type="radio" id="male" name="drone" value="male" checked />
          <label for="male">male</label>
        </div>
    
        <div>
          <input type="radio" id="female" name="drone" value="female" />
          <label for="female">female</label>
        </div>
    
        <div>
          <input type="radio" id="neutral" name="drone" value="neutral" />
          <label for="neutral">neutral</label>
        </div>
      </fieldset>

      <button id="push-voices-button">Push to logs server</button>
    </div>
      <div id="push-response-div" />
    
    
    </body>
  
  </html>