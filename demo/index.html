<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Readium Speech Demo</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- <script>
      console.log(speechSynthesis.getVoices());
      setTimeout(() => console.log(speechSynthesis.getVoices()), 1);
  </script> -->
    <script type="module" defer>

      // console.log(speechSynthesis.getVoices());
      // setTimeout(() => console.log(speechSynthesis.getVoices()), 1);

      import { voicesSelection } from "../build/index.js";
      const { getSpeechSynthesisVoices, parseSpeechSynthesisVoices, filterOnNovelty, filterOnVeryLowQuality,
        filterOnRecommended, sortByLanguage, sortByQuality, getVoices, groupByKindOfVoices, groupByRegions,
        getLanguages } = voicesSelection;

      // console.log(filterOnRecommended(filterOnVeryLowQuality(filterOnNovelty(parseSpeechSynthesisVoices(await getSpeechSynthesisVoices())))));
      // console.log(sortByLanguage(sortByQuality(filterOnRecommended(filterOnVeryLowQuality(filterOnNovelty(parseSpeechSynthesisVoices(await getSpeechSynthesisVoices()))))[0])));

      const languages = await getLanguages();
      console.log(languages);

      const voices = await getVoices();
      console.log(voices);

      const allVoices = parseSpeechSynthesisVoices(await getSpeechSynthesisVoices());
      console.log(groupByKindOfVoices(allVoices));
      // console.log(JSON.stringify(Array.from(groupByKindOfVoices(allVoices).entries()), null, 4));

      const languageSelect = document.getElementById('language-select'); 

      for (const {language: lang, label: langLabel, count: langCount} of languages) {
        const opt = document.createElement("option");
        opt.value = lang;
        opt.text = `${langLabel} (${langCount})`;
        languageSelect.appendChild(opt);
      }
      

      languageSelect.addEventListener('change', async function () {

        const defaultOption = document.getElementById("default-language-select");
        if (defaultOption) {
          defaultOption.remove();
        }

        const selectedLanguage = languageSelect.value;

        const jsonData = await loadJSONData("https://raw.githubusercontent.com/HadrienGardeur/web-speech-recommended-voices/main/json/" + selectedLanguage + ".json");

        const defaultText = document.getElementById('text-to-read');
        defaultText.value = jsonData?.testUtterance || "hello world";

        const voiceMap = groupByRegions(voices, selectedLanguage, undefined, navigator.language.split("-")[0].toLowerCase());
        console.log(voiceMap);

        const voiceDropdownHTML = generateVoiceDropdownHTML(voiceMap);
        document.getElementById('voice-select').outerHTML = voiceDropdownHTML;
      });

      document.getElementById('read-button').addEventListener('click', readTextWithSelectedVoice);

      async function loadJSONData(url) {
        try {
          const response = await fetch(url);
          const jsonData = JSON.parse(await response.text());
          return jsonData;
        } catch (error) {
          console.error('Error loading JSON data:', error);
          return null;
        }
      }

      // function filterAvailableVoices(jsonData) {
      //   if (!jsonData) return [];

      //   const availableVoices = [];
      //   const voices = speechSynthesis.getVoices();

      //   jsonData.voices.forEach(
      //     function (voice) {
      //       if (voices.some(apiVoice => apiVoice.name === voice.name)) {
      //         availableVoices.push(voice);
      //       }
      //       else {
      //         if (voice.altNames) {
      //           voice.altNames.forEach(
      //             function (altName) {
      //               if (voices.some(apiVoice => apiVoice.name === altName)) {
      //                 voice.name = altName;
      //                 availableVoices.push(voice);
      //               }
      //             }
      //           )
      //         }
      //       }
      //     }
      //   );

      //   return availableVoices;
      // }

      // function groupVoicesByRegion(voices) {
      //   const regions = {};

      //   voices.forEach(voice => {
      //     const region = extractRegionFromLang(voice.language) || 'Other';
      //     if (!regions[region]) {
      //       regions[region] = [];
      //     }
      //     regions[region].push(voice);
      //   });

      //   return regions;
      // }

      // function extractRegionFromLang(lang) {
      //   if (!lang) return null;
      //   const parts = lang.split('-');
      //   return parts.length > 1 ? parts[1] : null;
      // }

      // function sortVoicesByRegionPreference(groupedVoices) {
      //   const acceptLanguages = navigator.languages;
      //   const primaryRegion = acceptLanguages.map(lang => extractRegionFromLang(lang) || 'Other');

      //   const sortedVoices = [];

      //   primaryRegion.forEach(region => {
      //     if (groupedVoices[region]) {
      //       sortedVoices.push(...groupedVoices[region]);
      //       delete groupedVoices[region];
      //     }
      //   });

      //   for (const region in groupedVoices) {
      //     sortedVoices.push(...groupedVoices[region]);
      //   }

      //   return sortedVoices;
      // }

      function generateVoiceDropdownHTML(voiceMap) {
        if (!voiceMap) return '';

        const voiceSelect = document.createElement('select');
        voiceSelect.id = 'voice-select';

        for (const [region, voice] of voiceMap) {
          const optgroup = document.createElement('optgroup');
          optgroup.label = region;
          (voice || []).forEach(function (v) {
            const voiceOption = document.createElement('option');
            voiceOption.value = v.name;
            voiceOption.textContent = v.label;
            optgroup.appendChild(voiceOption);
          });
          voiceSelect.appendChild(optgroup);
        }

        return voiceSelect.outerHTML;
      }

      function readTextWithSelectedVoice() {
        const textToRead = document.getElementById('text-to-read').value;
        const selectedVoice = document.getElementById('voice-select').value;
        const voices = window.speechSynthesis.getVoices();

        if (!textToRead || !selectedVoice) return;

        const utterance = new SpeechSynthesisUtterance();
        utterance.text = textToRead;

        for (const voice of voices) {
          if (voice.name === selectedVoice) {
            utterance.voice = voice;
            utterance.lang = voice.lang;
            break;
          }
        }

        speechSynthesis.speak(utterance);
      }


    </script>
  </head>
  
  <body>
    <h1>Readium Speech Demo</h1>
  
    <p>Language :</p>
    <select id="language-select">
      <option id="default-language-select" default>Select a language</option>
      <!-- <option value="ca">Catalan</option>
      <option value="da">Danish</option>
      <option value="nl">Dutch</option>
      <option value="en">English</option>
      <option value="fi">Finnish</option>
      <option value="fr">French</option>
      <option value="de">German</option>
      <option value="it">Italian</option>
      <option value="nb">Norwegian</option>
      <option value="pt">Portuguese</option>
      <option value="es">Spanish</option>
      <option value="sv">Swedish</option> -->
    </select>
  
    <p>Voices :</p>
    <select id="voice-select"></select>
  
    <p>Text :</p>
    <input id="text-to-read" class="txt"></input>
  
    <div class="controls">
      <button id="read-button">Read aloud</button>
    </div>
  </body>
  
  </html>